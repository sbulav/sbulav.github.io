---
import BaseLayout from './BaseLayout.astro';
import Sidebar from '../components/Sidebar.astro';
import Giscus from '../components/Giscus.astro';
import TableOfContents from '../components/TableOfContents.astro';
import { formatDate, readingTime, getPostSlug } from '../lib/utils';

interface Props {
  title: string;
  date: Date;
  categories: string[];
  tags: string[];
  toc?: boolean;
  comments?: boolean;
  body?: string;
  headings?: Array<{ depth: number; slug: string; text: string }>;
  slug?: string;
}

const { title, date, categories, tags, toc = false, comments = true, body = '', headings = [], slug = '' } = Astro.props;
const readTime = readingTime(body);
const catPath = categories.map(c => c.toLowerCase()).join('/');
// Extract filename from slug (e.g., "til/til-webrtc-landing-page" -> "til-webrtc-landing-page.md")
const filename = slug ? slug.split('/').pop() + '.md' : title.toLowerCase().replace(/\s+/g, '-').slice(0, 40) + '.md';
---

<BaseLayout title={title} description={`${title} - Cloud Alchemist blog post`}>
  <div class="relative">
    <Sidebar />
    <article class="mt-4">
    <!-- Terminal-style header -->
    <div class="mb-8 border border-border rounded-lg bg-bg-secondary p-5 font-mono text-sm">
      <!-- Command line -->
      <div class="text-fg-dim mb-3">
        <span class="text-accent">~/blog{catPath ? `/${catPath}` : ''}</span>
        <span class="text-fg-dim"> $ </span>
        <span class="text-fg">cat</span>
        <span class="text-tag"> {filename}</span>
      </div>

      <div class="border-t border-border my-3"></div>

      <!-- Metadata -->
      <div class="grid gap-1.5 text-sm">
        <div class="flex items-center gap-2">
          <span class="text-fg-dim w-24">title:</span>
          <span class="text-fg">{title}</span>
        </div>

        <div class="flex items-center gap-2">
          <span class="text-fg-dim w-24">date:</span>
          <time datetime={date.toISOString()} class="text-date">
            {formatDate(date)}
          </time>
        </div>

        {categories.length > 0 && (
          <div class="flex items-center gap-2">
            <span class="text-fg-dim w-24">categories:</span>
            <span class="flex flex-wrap gap-2">
              {categories.map((cat, i) => (
                <span>
                  <a href={`/categories/${cat.toLowerCase()}`} class="text-category hover:text-category-hover hover:underline transition-colors">
                    {cat.toLowerCase()}
                  </a>
                  {i < categories.length - 1 && <span class="text-fg-dim">, </span>}
                </span>
              ))}
            </span>
          </div>
        )}

        {tags.length > 0 && (
          <div class="flex items-center gap-2">
            <span class="text-fg-dim w-24">tags:</span>
            <span class="flex flex-wrap gap-2">
              {tags.map((tag, i) => (
                <span>
                  <a href={`/tags/${tag.toLowerCase()}`} class="text-tag hover:text-tag-hover hover:underline transition-colors">
                    {tag.toLowerCase()}
                  </a>
                  {i < tags.length - 1 && <span class="text-fg-dim">, </span>}
                </span>
              ))}
            </span>
          </div>
        )}

        <div class="flex items-center gap-2">
          <span class="text-fg-dim w-24">reading:</span>
          <span class="text-date">{readTime} min</span>
        </div>
      </div>
    </div>

    <!-- Table of contents -->
    {toc && headings.length > 0 && (
      <TableOfContents headings={headings} />
    )}

    <!-- Post content -->
    <div class="prose">
      <slot />
    </div>

    <!-- Tags footer -->
    {tags.length > 0 && (
      <div class="mt-12 border-t border-border pt-6">
        <div class="flex flex-wrap gap-2">
          {tags.map(tag => (
            <a
href={`/tags/${tag.toLowerCase()}`}
              class="rounded border border-border bg-bg-secondary px-3 py-1.5 text-sm text-tag hover:border-tag hover:text-tag-hover transition-colors"
            >
              #{tag.toLowerCase()}
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Comments -->
    {comments && (
      <div class="mt-12 border-t border-border pt-6">
        <Giscus />
      </div>
    )}
    </article>
  </div>
</BaseLayout>
