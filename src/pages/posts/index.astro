---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { sortPostsByDate, groupPostsByYear, getPostSlug } from '../../lib/utils';

const allPosts = sortPostsByDate(await getCollection('blog'));
const postsByYear = groupPostsByYear(allPosts);
---

<BaseLayout title="All Posts">
  <div class="mb-6">
    <div class="font-mono text-xs text-terminal-muted">
      <span class="text-terminal-accent">~/blog</span>
      <span> $ </span>
      <span class="text-terminal-fg">find posts/ -name "*.md" | sort -r | group-by year</span>
    </div>
    <h1 class="mt-3 font-mono text-lg font-bold text-terminal-accent">All Posts</h1>
    <p class="font-mono text-xs text-terminal-muted">{allPosts.length} posts total</p>
  </div>

  {[...postsByYear.entries()].map(([year, posts]) => (
    <section class="mb-8">
      <h2 class="mb-3 flex items-center gap-2 font-mono text-sm">
        <span class="text-terminal-success font-bold">{year}</span>
        <span class="text-[10px] text-terminal-muted">({posts.length} posts)</span>
        <span class="flex-1 border-t border-terminal-border"></span>
      </h2>
      <div class="space-y-2">
        {posts.map(post => (
          <PostCard
            title={post.data.title}
            date={post.data.date}
            categories={post.data.categories}
            tags={post.data.tags}
            slug={getPostSlug(post.id, post.data.categories)}
            body={post.body || ''}
          />
        ))}
      </div>
    </section>
  ))}
</BaseLayout>
